name: PHPCS Code Check

on: [push, pull_request]

jobs:
  phpcs-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install PHPCS and Variable Analysis
      run: |
        composer require --dev "squizlabs/php_codesniffer=*"
        composer config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer require --dev dealerdirect/phpcodesniffer-composer-installer
        composer require --dev sirbrillig/phpcs-variable-analysis

    - name: Check PHP Code Sniffer Rules
      run: |
        ./vendor/bin/phpcs -i

    - name: Fetch base branch
      run: git fetch --depth=1 origin ${{ github.base_ref }}

    - name: Run PHPCS on modified PHP files
      run: |
        CHANGED_FILES=$(git diff --name-only ${{ github.base_ref }} HEAD | grep '\.php$')
        if [ -n "$CHANGED_FILES" ]; then
          ./vendor/bin/phpcs $CHANGED_FILES --standard=VariableAnalysis
        else
          echo "No PHP files have been modified."
        fi
